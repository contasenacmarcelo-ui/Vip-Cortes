<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vip Cortes</title>
  <link rel="stylesheet" href="style2(admin).css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Big+Shoulders:opsz,wght@10..72,100..900&display=swap"
    rel="stylesheet">
</head>


<body>
  <header>
    <div class="imagem">
      <a class="logo-vipcortes" href="index.html"><img src="./assets/Vip cortes logo.png" alt=""></a>

    </div>
    <div class="nav-main">
      <nav class="margem-esquerda">
        <a class="item" href="index.html"><b>Home</b></a>
      <a class="item" href="Avaliações.html"><b>Avaliações</b></a>
      <a class="item" href="AGENDAR.html"><b>Agendar</b></a>
      <a class="item22" href="admin.html"><b>admin</b></a>
      </nav>
      <nav class="margem-direita">
        <a class="item" href="cartaofidelidade.html"><b>Entrar</b></a>
        <a class="item2" href="criandoconta.html"><b>Cadastre-se</b></a>
      </nav>
    </div>
  </header>
  <main>
    <section>
      <div class="line-branca-one"></div>
      <div class="line-branca-two"></div>
      <div class="title-admin">ADMINISTRAÇÃO</div>
    </section>
    <!-- tabela -->
    <div class="tabela-container">
      <table class="agenda">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Telefone</th>
            <th>Serviço</th>
            <th>Data</th>
            <th>Horário</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody id="agendaBody">
          <!-- linhas serão preenchidas via JS -->
        </tbody>
      </table>
    </div>


  </main>

  <script src="main.js" defer></script>
  <script>
    // Preenche tabela de agendamentos via API e adiciona botões Excluir / Adicionar Pontos
    async function carregarAgendamentos() {
      try {
        const res = await fetch('/api/agendamentos');
        const j = await res.json();
        const rows = j.appointments || [];
        const tbody = document.getElementById('agendaBody');
        tbody.innerHTML = '';
        for (const a of rows) {
          const tr = document.createElement('tr');
          const clienteTd = document.createElement('td'); clienteTd.textContent = a.name || '';
          const telefoneTd = document.createElement('td'); telefoneTd.textContent = a.phone || '';
          const servTd = document.createElement('td'); servTd.textContent = a.service || '';
          const dataTd = document.createElement('td'); dataTd.textContent = a.data_agendamento || a.date || '';
          const horaTd = document.createElement('td'); horaTd.textContent = a.hora || a.time || '';
          const actionTd = document.createElement('td');

          const delBtn = document.createElement('button'); delBtn.className = 'btn-excluir'; delBtn.textContent = 'Excluir';
          delBtn.addEventListener('click', async () => {
            if (!confirm('Excluir este agendamento?')) return;
            await fetch(`/api/agendamentos/${a.id}`, { method: 'DELETE' });
            carregarAgendamentos();
          });

          const addBtn = document.createElement('button'); addBtn.className = 'btn-adicionar'; addBtn.textContent = 'Adicionar Pontos';
          addBtn.addEventListener('click', async () => {
            // prompt para usuário inserir email ou userId e quantidade de pontos
            const who = prompt('Informe userId ou email do usuário (ex: 12 ou usuario@ex.com):');
            if (!who) return;
            const ptsStr = prompt('Quantos pontos adicionar? (número)');
            const pts = Number(ptsStr);
            if (!Number.isFinite(pts)) { alert('Número inválido'); return; }
            const payload = {};
            if (/^\d+$/.test(who)) payload.usuario_id = Number(who); else payload.email = who;
            payload.points = pts;
            const r = await fetch('/api/fidelities/adjust', { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
            const jr = await r.json();
            if (!r.ok) alert(jr.error || 'Erro'); else alert(jr.message + '\nPontos atuais: ' + (jr.pontos ?? 'n/a'));
          });

          actionTd.appendChild(delBtn);
          actionTd.appendChild(document.createTextNode(' '));
          actionTd.appendChild(addBtn);

          tr.appendChild(clienteTd);
          tr.appendChild(telefoneTd);
          tr.appendChild(servTd);
          tr.appendChild(dataTd);
          tr.appendChild(horaTd);
          tr.appendChild(actionTd);
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error('Erro ao carregar agendamentos:', err);
      }
    }

    document.addEventListener('DOMContentLoaded', carregarAgendamentos);
  </script>
</body>

</html>